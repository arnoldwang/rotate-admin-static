<script>
var kom = require('knockout.mapping');
var _ = require('lodash');
model = [
    function() {
        this.reset();

        if (!this.ChildNodeClass) {
            this.ChildNodeClass = this.constructor;
        }
    },
    {
        ChildNodeClass: null,

        DATA_CHILDREN_PROP: 'children',

        reset: function() {
            this.setData({
                children: [],

                __expand: false
            });
        },

        setData: function(o) {
            var data = _.extend({}, o);

            var children = data[this.DATA_CHILDREN_PROP];
            data[this.DATA_CHILDREN_PROP] = [];
            
            kom.fromJS(data, null, this);

            if (children) {
                this.children(children.map(this.createChildNode, this));
            }
        },

        expand: function() {
            this.__expand(true);
        },

        collapse: function() {
            this.__expand(false);
        },

        createChildNode: function(data) {
            var child = new this.ChildNodeClass();
            child.setData(data);
            return child;
        },

        cascadeParentFirst: function(fn) {
            fn(this);
            this.children().forEach(function(child) {
                child.cascadeParentFirst(fn)
            })
        },

        cascadeChildFirst: function(fn) {
            this.children().forEach(function(child) {
                child.cascadeChildFirst(fn)
            });
            fn(this);
        }
    }
]
</script>