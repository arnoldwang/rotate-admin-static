<div class="panel panel-default">
    <div class="panel-body">
        <div class="form-inline op">
            <!-- ko module: modules.biz --><!-- /ko -->
            <!-- ko module: modules.city --><!-- /ko -->
            <button class="btn btn-default" data-bind="click: search">查询</button>
        
            <div class="form-group">
                <!-- ko module: modules.filterNoTerritory --><!-- /ko -->
                <!-- ko module: modules.filterNoTerritoryChief --><!-- /ko -->    
            </div>        
        </div>
    </div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>
                    小组
                </th>
                <th>
                    战区
                </th>
                <th>
                    战区长官
                </th>
            </tr>
        </thead>
        <tbody data-bind="foreach: filteredItems">
            <tr>
                <td>{{teamName}}</td>
                <td>{{territoryName}}</td>
                <td>{{territoryChiefName}}</td>
            </tr>
        </tbody>
    </table>
</div>


<script>
    var _ = require('lodash');
    var ko = require('knockout');
    var kom = require('knockout.mapping');
    var notification = require('service/notification');

    // control
    var SimpleFormGroup = require('module/control/simple-form-group');
    var TextBox = require('module/control/text-box');
    var Select = require('module/control/select');


    model = [
        function() {
            this.reset();
            this.buildModules();

            this.filteredItems = ko.pureComputed(function() {
                var items = this.teams();

                if (this.filterNoTerritory()) {
                    items = items.filter(function(item) {
                        return !item.territoryName;
                    })
                }

                if (this.filterNoTerritoryChief()) {
                    items = items.filter(function(item) {
                        return !item.territoryChiefName;
                    })
                }

                var cityId = this.filterCityId()
                if (cityId) {
                    items = items.filter(function(item) {
                        return item.cityId === cityId;
                    })
                }

                return items;
            }, this);
        },
        {
            reset: function() {
                this.setData({
                   bizId: null,
                   teams: [],

                   filterCityId: null,
                   cityName: null,

                   filterNoTerritory: false,
                   filterNoTerritoryChief: false
                });
            },

            buildModules: function() {
                this.modules = {
                    biz: new SimpleFormGroup({
                        content: new Select({
                            value: this.bizId,
                            options: enums.biz
                        }),
                        label: 'BU'
                    }),

                    city: new SimpleFormGroup({
                        content: new (require('module/control/city-typeahead'))({
                            value: this.filterCityId,
                            text: this.cityName
                        }),
                        label: '城市'
                    }),

                    filterNoTerritory:  new (require('module/control/checkbox'))({
                        value: this.filterNoTerritory,
                        text: '无战区'
                    }),

                    filterNoTerritoryChief:  new (require('module/control/checkbox'))({
                        value: this.filterNoTerritoryChief,
                        text: '无战区长官'
                    })
                }
            },

            search: function() {
                notification.info('加载中...', {
                    timeOut: 0
                });

                this.fetch({
                    url: '/team/query',
                    data: {
                        bizId: this.bizId
                    },
                    success: function(teams) {
                        this.teams(teams);
                    },
                    complete: function() {
                        notification.clear();                        
                    }
                })
            }
        }
    ]
</script>